generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MEMBER
}

enum ContactType {
  CANDIDATE
  ELECTED_OFFICIAL
  STAFF
  ORGANIZATION
}

enum CommunicationType {
  PHONE_CALL
  MEETING_IN_PERSON
  MEETING_VIRTUAL
  EMAIL
  LETTER_MAILER
  EVENT_ACTION
  TEXT
  LEFT_VOICEMAIL
}

enum TaxStatus {
  C501C3
  C501C4
  C501C5
  C501C6
  FOR_PROFIT
  GOVERNMENT
  OTHER
}

enum EndorsementDecision {
  PENDING
  ENDORSED
  NOT_ENDORSED
  NO_ENDORSEMENT
}

enum ElectionType {
  PRIMARY
  GENERAL
  SPECIAL
}

enum TaskStatus {
  PENDING
  DONE
}

enum DigestFrequency {
  DAILY
  WEEKLY
  NONE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
}

enum CampaignType {
  ONE_TIME
  DRIP_SEQUENCE
}

enum ContactRating {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ResponseStatus {
  AWAITING
  RESPONDED
  NO_RESPONSE
  NOT_APPLICABLE
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  endorsements     Endorsement[]
  tasks            Task[]
  activityLogs     ActivityLog[]
  digestPreference DigestPreference?
}

model MagicLink {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email])
}

model Contact {
  id              String      @id @default(cuid())
  type            ContactType
  firstName       String
  lastName        String
  title           String?
  organization    String?
  phone           String?
  email           String?
  address         String?
  city            String?
  state           String?
  zip             String?
  district        String?
  party           String?
  website         String?
  twitter         String?
  facebook        String?
  instagram       String?
  tags            String[]
  notes           String?
  taxStatus       TaxStatus?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  communications      CommunicationContact[]
  endorsements        Endorsement[]
  raceCandidates      RaceCandidate[]
  tasks               Task[]
  attachments         Attachment[]
  staffAssignments    StaffAssignment[] @relation("StaffAssignments")
  parentAssignments   StaffAssignment[] @relation("ParentAssignments")
  positionAssignments PositionAssignment[]
  ratingHistory       ContactRatingHistory[]

  @@index([lastName, firstName])
  @@index([tags], type: Gin)
}

model StaffAssignment {
  id              String    @id @default(cuid())
  staffContactId  String
  staffContact    Contact   @relation("StaffAssignments", fields: [staffContactId], references: [id], onDelete: Cascade)
  parentContactId String
  parentContact   Contact   @relation("ParentAssignments", fields: [parentContactId], references: [id], onDelete: Cascade)
  role            String?
  startDate       DateTime  @default(now())
  endDate         DateTime?
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([staffContactId])
  @@index([parentContactId])
}

model Communication {
  id             String            @id @default(cuid())
  type           CommunicationType
  date           DateTime
  subject        String
  notes          String?
  followUpDate   DateTime?
  endorsementId  String?
  endorsement    Endorsement?      @relation(fields: [endorsementId], references: [id], onDelete: SetNull)
  responseStatus ResponseStatus    @default(NOT_APPLICABLE)
  responseDate   DateTime?
  responseNotes  String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  contacts    CommunicationContact[]
  attachments Attachment[]
}

model CommunicationContact {
  communicationId String
  contactId       String
  communication   Communication @relation(fields: [communicationId], references: [id], onDelete: Cascade)
  contact         Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([communicationId, contactId])
}

model PipelineStage {
  id                 String               @id @default(cuid())
  name               String
  order              Int                  @unique
  isFinal            Boolean              @default(false)
  color              String               @default("#6B7280")
  decisionOnComplete EndorsementDecision? // Only set for isFinal=true stages

  endorsements         Endorsement[]
  endorsementHistories EndorsementStageHistory[]
  questionnaires       Questionnaire[]
}

model Endorsement {
  id                    String              @id @default(cuid())
  decision              EndorsementDecision @default(PENDING)
  candidateId           String
  candidate             Contact             @relation(fields: [candidateId], references: [id])
  raceId                String
  race                  Race                @relation(fields: [raceId], references: [id])
  currentStageId        String
  currentStage          PipelineStage       @relation(fields: [currentStageId], references: [id])
  assignedToId          String?
  assignedTo            User?               @relation(fields: [assignedToId], references: [id])
  notes                 String?
  lockedAt              DateTime?
  previousEndorsementId String?
  previousEndorsement   Endorsement?        @relation("ReEndorsement", fields: [previousEndorsementId], references: [id])
  reEndorsements        Endorsement[]       @relation("ReEndorsement")
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  stageHistory             EndorsementStageHistory[]
  communications           Communication[]
  tasks                    Task[]
  attachments              Attachment[]
  questionnaireResponses   QuestionnaireResponse[]
}

model EndorsementStageHistory {
  id            String        @id @default(cuid())
  endorsementId String
  endorsement   Endorsement   @relation(fields: [endorsementId], references: [id], onDelete: Cascade)
  stageId       String
  stage         PipelineStage @relation(fields: [stageId], references: [id])
  enteredAt     DateTime      @default(now())
  exitedAt      DateTime?
  notes         String?
}

model Election {
  id        String       @id @default(cuid())
  name      String
  type      ElectionType
  date      DateTime
  cycle     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  races Race[]
}

model Race {
  id         String   @id @default(cuid())
  office     String
  district   String?
  electionId String
  election   Election @relation(fields: [electionId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  candidates   RaceCandidate[]
  endorsements Endorsement[]

  @@unique([office, district, electionId])
}

model RaceCandidate {
  raceId      String
  contactId   String
  isIncumbent Boolean @default(false)
  race        Race    @relation(fields: [raceId], references: [id], onDelete: Cascade)
  contact     Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@id([raceId, contactId])
}

model Task {
  id            String       @id @default(cuid())
  title         String
  description   String?
  dueDate       DateTime?
  status        TaskStatus   @default(PENDING)
  assignedToId  String?
  assignedTo    User?        @relation(fields: [assignedToId], references: [id])
  contactId     String?
  contact       Contact?     @relation(fields: [contactId], references: [id])
  endorsementId String?
  endorsement   Endorsement? @relation(fields: [endorsementId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model Attachment {
  id              String         @id @default(cuid())
  fileName        String
  fileKey         String
  fileSize        Int
  mimeType        String
  contactId       String?
  contact         Contact?       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  communicationId String?
  communication   Communication? @relation(fields: [communicationId], references: [id], onDelete: Cascade)
  endorsementId   String?
  endorsement     Endorsement?   @relation(fields: [endorsementId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())
}

model ActivityLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  summary    String
  metadata   Json?
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@index([createdAt])
}

model DigestPreference {
  id        String          @id @default(cuid())
  frequency DigestFrequency @default(NONE)
  userId    String          @unique
  user      User            @relation(fields: [userId], references: [id])
}

model PositionAssignment {
  id            String    @id @default(cuid())
  contactId     String
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  positionTitle String
  jurisdiction  String?
  startDate     DateTime  @default(now())
  endDate       DateTime?
  notes         String?
  createdAt     DateTime  @default(now())

  @@index([contactId])
}

model DigestSubscriber {
  id        String          @id @default(cuid())
  email     String          @unique
  name      String
  frequency DigestFrequency @default(WEEKLY)
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([frequency, isActive])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  body      String   // HTML content with {{variables}}
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns     Campaign[]
  sequenceSteps SequenceStep[]
}

model Campaign {
  id     String         @id @default(cuid())
  name   String
  type   CampaignType   @default(ONE_TIME)
  status CampaignStatus @default(DRAFT)

  // For ONE_TIME campaigns
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id])
  subject    String?        // Can override template subject
  body       String?        // Can override template body

  scheduledAt DateTime? // When to send (null = immediate when triggered)
  sentAt      DateTime? // When actually sent

  // Stats (denormalized for quick access)
  totalRecipients Int @default(0)
  totalSent       Int @default(0)
  totalOpened     Int @default(0)
  totalClicked    Int @default(0)
  totalBounced    Int @default(0)
  totalReplied    Int @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String

  recipients    CampaignRecipient[]
  sequenceSteps SequenceStep[]
  emailEvents   EmailEvent[]

  @@index([status])
  @@index([scheduledAt])
}

model SequenceStep {
  id         String        @id @default(cuid())
  campaignId String
  campaign   Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  templateId String
  template   EmailTemplate @relation(fields: [templateId], references: [id])
  subject    String?       // Override template subject
  body       String?       // Override template body
  delayDays  Int           // Days after previous step (0 for first step)
  stepOrder  Int           // Order in sequence
  createdAt  DateTime      @default(now())

  @@index([campaignId, stepOrder])
}

model CampaignRecipient {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId  String
  email      String   // Snapshot of email at send time
  emailStaff Boolean  @default(false) // true = email their staff, false = email directly

  // For drip sequences: track progress
  currentStep Int       @default(0)
  nextSendAt  DateTime?

  // Status per recipient
  sentAt    DateTime?
  openedAt  DateTime?
  clickedAt DateTime?
  bouncedAt DateTime?
  repliedAt DateTime?

  resendId String? // Resend message ID for tracking

  createdAt DateTime @default(now())

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([nextSendAt])
}

model EmailEvent {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  resendId   String   // Resend message ID
  eventType  String   // delivered, opened, clicked, bounced, complained, replied
  metadata   Json?    // Link clicked, etc.
  createdAt  DateTime @default(now())

  @@index([campaignId])
  @@index([resendId])
}

model EmailSuppression {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String   // UNSUBSCRIBE, BOUNCE, COMPLAINT, MANUAL
  source    String?  // campaignId or "manual"
  createdAt DateTime @default(now())

  @@index([email])
}

model Questionnaire {
  id        String     @id @default(cuid())
  name      String
  stageId   String?    // Auto-request when entering this stage
  stage     PipelineStage? @relation(fields: [stageId], references: [id], onDelete: SetNull)
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  questions Question[]
  responses QuestionnaireResponse[]

  @@index([stageId])
}

model Question {
  id              String        @id @default(cuid())
  questionnaireId String
  questionnaire   Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  text            String
  type            String        // TEXT, TEXTAREA, SINGLE_CHOICE, MULTI_CHOICE
  options         String[]      // For choice questions
  required        Boolean       @default(false)
  order           Int

  @@index([questionnaireId])
}

model QuestionnaireResponse {
  id              String         @id @default(cuid())
  questionnaireId String
  questionnaire   Questionnaire  @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  endorsementId   String
  endorsement     Endorsement    @relation(fields: [endorsementId], references: [id], onDelete: Cascade)
  answers         Json           // { questionId: answer }
  submittedAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([questionnaireId, endorsementId])
  @@index([endorsementId])
}

model ContactRatingHistory {
  id        String        @id @default(cuid())
  contactId String
  contact   Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  year      Int
  rating    ContactRating
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([contactId, year])
  @@index([contactId])
  @@index([year])
  @@index([rating])
}
